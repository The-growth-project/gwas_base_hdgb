------------------------------------------------------------------------

---
title: "phenotypes"
format: gmd
editor: visual
---

## *Phenotypes*

*Preparation of the phenotype table for the GWAS pipeline and documentation of phenotypic distribution.*

### *Libraries and settings*

```{r}

library(here)
library(conflicted)
library(yaml)
library(janitor)
library(glue)
library(tidyverse)
library(ggplot2)
library(scico)
library(patchwork)
library(ragg)
library(grid)

# Solve name space conflicts
conflicts_prefer(dplyr::filter)


# General parameters
theme_set(theme_bw(base_size = 24))

```

### *Load data from pheno release*

```{r}

pheno_version <- "pheno_anthropometrics_25-12-12_hdgb"

mfr_data <- read.table(
  file = glue("/mnt/archive/moba/pheno/v12/{pheno_version}/mfr.gz"),
  header = T,
  sep = "\t"
)

population_clusters <- read.table(
  file = "/mnt/archive/moba/geno/HDGB-MoBaGenetics/2025.09.25/pca/moba_genotypes_2025.09.25_clusters",
  header = T,
  sep = "\t"
)

```

### *Make a table with phenotypes, exclusion variables, and covariates*

```{r}

required_columns <- c("preg_id", "child_id", "mother_id", "father_id", "child_sentrix_id", "mother_sentrix_id", "father_sentrix_id", "child_batch", "mother_batch", "father_batch")
exclusion_columns <- c("pregnancy_duration_term", "pop_inference")
covariate_columns <- c("n_previous_deliveries", "pregnancy_duration", "plural_birth", "sex")
phenotype_columns <- c("weight_birth")

phenotype_data <- mfr_data %>% 
  left_join(
    population_clusters %>% 
      select(
        child_sentrix_id = iid,
        pop_inference
      ),
    by = "child_sentrix_id"
  ) %>% 
  mutate(
    n_previous_deliveries = factor(n_previous_deliveries, levels = c("0 (primiparous)", "1", "2", "3", "4 or more")),
    plural_birth = ifelse(is.na(plural_birth), "Single", "Plural"),
    plural_birth = factor(plural_birth, levels = c("Single", "Plural")),
    sex = case_when(
      sex == 1 ~ "Male",
      sex == 2 ~ "Female"
    ),
    sex = factor(sex, levels = c("Female", "Male"))
  ) %>% 
  select(
    all_of(required_columns), all_of(exclusion_columns), all_of(covariate_columns), all_of(phenotype_columns)
  )

```

### *Exclusion*

```{r}

print("Number of participants before exclusion")
n_pregnancies <- length(unique(phenotype_data$preg_id))
print(paste0("- N pregnancies: ", n_pregnancies))
n_children_genotyped <- length(unique(phenotype_data$child_sentrix_id))
print(paste0("- N children genotyped: ", n_children_genotyped))
n_mothers_genotyped <- length(unique(phenotype_data$mother_sentrix_id))
print(paste0("- N mothers genotyped: ", n_mothers_genotyped))
n_fathers_genotyped <- length(unique(phenotype_data$father_sentrix_id))
print(paste0("- N fathers genotyped: ", n_fathers_genotyped))

print("Exclusion of PCA outliers")

n_pregnancies_previous <- n_pregnancies
n_children_genotyped_previous <- n_children_genotyped
n_mothers_genotyped_previous <- n_mothers_genotyped
n_fathers_genotyped_previous <- n_fathers_genotyped

phenotype_data <- phenotype_data %>% 
  filter(
    pop_inference %in% c("EUR", "EUR_core")
  )

n_pregnancies <- length(unique(phenotype_data$preg_id))
print(paste0("- N pregnancies excluded : ", n_pregnancies_previous - n_pregnancies))
n_children_genotyped <- length(unique(phenotype_data$child_sentrix_id))
print(paste0("- N children genotyped excluded: ", n_children_genotyped_previous - n_children_genotyped))
n_mothers_genotyped <- length(unique(phenotype_data$mother_sentrix_id))
print(paste0("- N mothers genotyped excluded: ", n_mothers_genotyped_previous - n_mothers_genotyped))
n_fathers_genotyped <- length(unique(phenotype_data$father_sentrix_id))
print(paste0("- N fathers genotyped excluded: ", n_fathers_genotyped_previous - n_fathers_genotyped))


print("Exclusion of birth before 37w or after 42w")

n_pregnancies_previous <- n_pregnancies
n_children_genotyped_previous <- n_children_genotyped
n_mothers_genotyped_previous <- n_mothers_genotyped
n_fathers_genotyped_previous <- n_fathers_genotyped

phenotype_data <- phenotype_data %>% 
  filter(
    pregnancy_duration_term == 1
  )

n_pregnancies <- length(unique(phenotype_data$preg_id))
print(paste0("- N pregnancies excluded : ", n_pregnancies_previous - n_pregnancies))
n_children_genotyped <- length(unique(phenotype_data$child_sentrix_id))
print(paste0("- N children genotyped excluded: ", n_children_genotyped_previous - n_children_genotyped))
n_mothers_genotyped <- length(unique(phenotype_data$mother_sentrix_id))
print(paste0("- N mothers genotyped excluded: ", n_mothers_genotyped_previous - n_mothers_genotyped))
n_fathers_genotyped <- length(unique(phenotype_data$father_sentrix_id))
print(paste0("- N fathers genotyped excluded: ", n_fathers_genotyped_previous - n_fathers_genotyped))


print("Remaining after exclusion criteria")
print(paste0("- N pregnancies: ", n_pregnancies))
print(paste0("- N children genotyped: ", n_children_genotyped))
print(paste0("- N mothers genotyped: ", n_mothers_genotyped))
print(paste0("- N fathers genotyped: ", n_fathers_genotyped))

```

### *Prevalence of covariates*

```{r}

discrete_covariate_columns <- c("n_previous_deliveries", "plural_birth", "sex")
discrete_covariate_names <- c("Parity", "Plural birth", "Sex")

for (i in 1:length(discrete_covariate_columns)) {
  
  column <- discrete_covariate_columns[i]
  column_name <- discrete_covariate_names[i]
  
  plot <- ggplot() +
    geom_bar(
      data = phenotype_data,
      mapping = aes(
        x = !!sym(column)
      )
    ) +
    scale_x_discrete(
      name = column_name
    ) +
    scale_y_continuous(
      name = "Number of pregnancies"
    ) +
    theme(
      axis.text.x = element_text(
        angle = 45,
        hjust = 1
      ),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
    )
  
png(
  filename = here(glue("phenotypes/plots/{column}_prevalence.png")),
  width = 800,
  height = 600
)
grid.draw(plot)
dev <- dev.off()
  
}


continuous_covariate_columns <- c("pregnancy_duration")
continuous_covariate_names <- c("Pregnancy duration")

for (i in 1:length(continuous_covariate_columns)) {
  
  column <- continuous_covariate_columns[i]
  column_name <- continuous_covariate_names[i]
  
  plot <- ggplot() +
    geom_histogram(
      data = phenotype_data,
      mapping = aes(
        x = !!sym(column)
      )
    ) +
    scale_x_continuous(
      name = column_name
    ) +
    scale_y_continuous(
      name = "Number of pregnancies"
    ) +
    theme(
      axis.text.x = element_text(
        angle = 45,
        hjust = 1
      ),
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank()
    )
  
png(
  filename = here(glue("phenotypes/plots/{column}_prevalence.png")),
  width = 800,
  height = 600
)
grid.draw(plot)
dev <- dev.off()
  
}

```

### *Phenotype relative to covariates*

```{r}

phenotype_columns <- c("weight_birth")
phenotype_column_names <- c("Birth weight")

discrete_covariate_columns <- c("n_previous_deliveries", "plural_birth", "sex")
discrete_covariate_names <- c("Parity", "Plural birth", "Sex")

continuous_covariate_columns <- c("pregnancy_duration")
continuous_covariate_names <- c("Pregnancy duration")

for (column_i in 1:length(phenotype_columns)) {
  
  column <- phenotype_columns[column_i]
  column_name <- phenotype_column_names[column_i]
  
  for (column_j in 1:length(discrete_covariate_columns)) {
    
    covariate_column <- discrete_covariate_columns[column_j]
    covariate_column_name <- discrete_covariate_names[column_j]
    
    plot <- ggplot(
      data = phenotype_data,
      mapping = aes(
        x = !!sym(covariate_column),
        y = !!sym(column)
      )
    ) +
      geom_violin(
        fill = "grey90"
      ) +
      geom_boxplot(
        width=0.3
      ) +
      scale_x_discrete(
        name = covariate_column_name
      ) +
      scale_y_continuous(
        name = column_name
      ) +
      theme(
        axis.text.x = element_text(
          angle = 45,
          hjust = 1
        ),
        panel.grid.major.x = element_blank()
      )
    
    png(
      filename = here(glue("phenotypes/plots/{column}_vs_{covariate_column}.png")),
      width = 800,
      height = 600
    )
    grid.draw(plot)
    dev <- dev.off()
    
  }
  
  
  for (column_j in 1:length(continuous_covariate_columns)) {
    
    covariate_column <- continuous_covariate_columns[column_j]
    covariate_column_name <- continuous_covariate_names[column_j]
    
    plot <- ggplot(
      data = phenotype_data,
      mapping = aes(
        x = as.numeric(!!sym(covariate_column)),
        y = !!sym(column)
      )
    ) +
      geom_point(
        alpha = 0.2
      ) +
      geom_smooth(
        # method = "loess"
      ) +
      geom_density2d(
        col = "white"
      ) +
      scale_x_continuous(
        name = covariate_column_name
      ) +
      scale_y_continuous(
        name = column_name
      )
    
    png(
      filename = here(glue("phenotypes/plots/{column}_vs_{covariate_column}.png")),
      width = 800,
      height = 600
    )
    grid.draw(plot)
    dev <- dev.off()
    
  }
}

```

### *Convert factors to numbers, save table of phenotypes*

```{r}

# Get the path to file expected by the gwas pipeline

gwas_settings <- read_yaml(file.path(here(), "gwas", "analysis.yaml"))

gwas_pheno_file_directory <- file.path(gwas_settings$work_folder, gwas_settings$id, gwas_settings$release, "pheno", gwas_settings$pheno_version, gwas_settings$pheno_release)

if (!dir.exists(gwas_pheno_file_directory)) {
  
  dir.create(gwas_pheno_file_directory, recursive = T)
  
}

gwas_pheno_file_path <- file.path(gwas_pheno_file_directory, glue("{gwas_settings$pheno_table_name}.gz"))


# Convert factors to numeric

phenotype_data_gwas <- phenotype_data

for (column in discrete_covariate_columns) {
  
  phenotype_data_gwas[[column]] <- as.numeric(phenotype_data_gwas[[column]])
  
}


# Write table

write.table(
  x = phenotype_data_gwas,
  file = gzfile(gwas_pheno_file_path),
  col.names = T,
  row.names = F,
  sep = "\t",
  quote = F
)

```
